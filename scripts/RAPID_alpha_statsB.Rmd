---
title: "RAPID Alpha Diversity Group Significance"
author: "Becca Maher"
date: "6/6/2019"
output: html_document
---
## Script for calculating alpha diversity statistics and testing for significant differences with metadata variables

### 1 Setup the working space
```{r libraries, include=FALSE}
rm(list=ls())
library(phyloseq)
library(multcomp)
library(picante)
library(ggplot2 )
library(tidyverse)
library(FSA)
library(MASS)
library(lme4)
library(lmerTest)
library(emmeans)
library(MuMIn)
library(nlme)
```

#### Functions
```{r functions}
# Arc-sine transformation
asinTransform <- function(p) { asin(sqrt(p)) }
# Calculate standard error
sderr <- function(x) {sd(x)/sqrt(length(x))}
#+++++++++++++++++++++++++
# Function to calculate the mean and the standard deviation
# for each group
#+++++++++++++++++++++++++
# data : a data frame
# varname : the name of a column containing the variable
#to be summariezed
# groupnames : vector of column names to be used as
# grouping variables
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sderr(x[[col]]), na.rm=TRUE)
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}

# function to visualize the boxplot, histogram, QQ-plot, and kernel density estimate plot for residuals
normality.plots <- function(x) {
  par(mfrow=c(2,2))
  hist(residuals(x), main = "Histogram", xlab = "Values")
  boxplot(residuals(x), main = "Boxplot", ylab = "Values")
  qqnorm(residuals(x))
  qqline(residuals(x))
  plot(density(residuals(x)), main = "Kernel Density Estimate")
}

# function to visaulize the fitted vs. residuals of model and the absolute residuals vs. fitted
var.plots <- function(x) {
  par(mfrow=c(1,2))
  plot(x = fitted(x), y = residuals(x), xlab="Fitted", ylab="Residuals")
  abline(h=0)
  title("Residuals vs. Fitted")
  plot(x = fitted(x), y = abs(residuals(x)), xlab="Fitted", ylab="Absolute Residuals")
  abline(h=0)
  title("Absolute Residuals vs. Fitted")
}
```

#### Load the data
Load the alphadiv.csv files created in the RAPID_alpha_statsA.Rmd script. First starting with all species
```{r load}
alphadiv <- read.csv("~/Box Sync/RAPID/RAPID-analysis/data/alphadiv.csv")
head(alphadiv)
```


### 2 Data Exploration
#### Data summaries
```{r}
# Data summaries
data_summary(alphadiv, varname = "richness", groupnames = c("treatment"))
data_summary(alphadiv, varname = "richness", groupnames = c("time"))
data_summary(alphadiv, varname = "richness", groupnames = c("species"))

data_summary(alphadiv, varname = "evenness", groupnames = c("treatment"))
data_summary(alphadiv, varname = "evenness", groupnames = c("time"))
data_summary(alphadiv, varname = "evenness", groupnames = c("species"))

data_summary(alphadiv, varname = "faithPD", groupnames = c("treatment"))
data_summary(alphadiv, varname = "faithPD", groupnames = c("time"))
data_summary(alphadiv, varname = "faithPD", groupnames = c("species"))

```
Looking for normality and homogeneity of group dispersions
#### Richness
```{r}
# box plot of richness by species
ggplot(alphadiv, aes(x = species, y = richness)) +  geom_boxplot()
# box plot of richness by time
ggplot(alphadiv, aes(x = time, y = richness)) +  geom_boxplot()
# box plot of richness by treatment
ggplot(alphadiv, aes(x = treatment, y = richness)) +  geom_boxplot()
# outlier is acropora, T3, Nitrate
# Testing for normality
histogram(alphadiv$richness)
qqnorm(alphadiv$richness)
abline(0,1)
shapiro.test(alphadiv$richness)
histogram(log(alphadiv$richness))
qqnorm(log(alphadiv$richness))
abline(0,1)
shapiro.test(log(alphadiv$richness))
histogram(sqrt(alphadiv$richness))
qqnorm(sqrt(alphadiv$richness))
abline(0,1)
shapiro.test(sqrt(alphadiv$richness))
# test for homogeneity of group dispersions
bartlett.test(sqrt(richness) ~ time, data = alphadiv)
bartlett.test(sqrt(richness) ~ treatment, data = alphadiv)
bartlett.test(sqrt(richness) ~ species, data = alphadiv)
# richness data are normal with equal group variances with a sqrt transformation
bartlett.test(richness ~ time, data = alphadiv)
bartlett.test(richness ~ treatment, data = alphadiv)
bartlett.test(richness ~ species, data = alphadiv)
# all significant without transformation
```
#### Evenness
```{r}
# box plot of evenness by species
ggplot(alphadiv, aes(x = species, y = evenness)) +  geom_boxplot()
# box plot of evenness by time
ggplot(alphadiv, aes(x = time, y = evenness)) +  geom_boxplot()
# box plot of evenness by treatment
ggplot(alphadiv, aes(x = treatment, y = evenness)) +  geom_boxplot()
# outlier is acropora, T3, Nitrate
# Testing for normality
histogram(alphadiv$evenness)
qqnorm(alphadiv$evenness)
abline(0,1)
shapiro.test(alphadiv$evenness) # non-normal
histogram(asinTransform(alphadiv$evenness))
qqnorm(asinTransform(alphadiv$evenness))
abline(0,1)
shapiro.test(asinTransform(alphadiv$evenness)) # non-normal
# test for homogeneity of group dispersions
bartlett.test(evenness ~ time, data = alphadiv)
bartlett.test(evenness ~ treatment, data = alphadiv)
bartlett.test(evenness ~ species, data = alphadiv)
# AsinTransformation does not make the evenness data normal
# Variances are equal for groups under un-transformed data
# will proceed with a non-Parametric Kruskal-Wallis test for evenness data
```
#### Faith's phylogenetic diversity
```{r}
# box plot of faithPD by species
ggplot(alphadiv, aes(x = species, y = faithPD)) +  geom_boxplot()
# box plot of faithPD by time
ggplot(alphadiv, aes(x = time, y = faithPD)) +  geom_boxplot()
# box plot of faithPD by treatment
ggplot(alphadiv, aes(x = treatment, y = faithPD)) +  geom_boxplot()
# outlier is acropora, T3, Nitrate
# Testing for normality
histogram(alphadiv$faithPD)
qqnorm(alphadiv$faithPD)
abline(0,1)
shapiro.test(alphadiv$faithPD) # non-normal
histogram(sqrt(alphadiv$faithPD))
qqnorm(sqrt(alphadiv$faithPD))
abline(0,1)
shapiro.test(sqrt(alphadiv$faithPD)) # non-normal
# test for homogeneity of group dispersions
bartlett.test(faithPD ~ time, data = alphadiv)
bartlett.test(faithPD ~ treatment, data = alphadiv)
bartlett.test(faithPD ~ species, data = alphadiv)

bartlett.test(sqrt(faithPD) ~ time, data = alphadiv)
bartlett.test(sqrt(faithPD) ~ treatment, data = alphadiv)
bartlett.test(sqrt(faithPD) ~ species, data = alphadiv) # sig
# Log transformation does not make the faithPD data normal, but sqrt-transform does
# Variances are equal for groups under un-transformed data
# Variances are equal for groups under sqrt-transformed data except for time
# Non-Parametric Kruskal-Wallis test
```

### 2 Analysis with linear-mixed effects models

```{r}
# Chao1 Index
# include random effect
lmerR <- lmer(sqrt(richness)~ time*treatment*species + (1|indiv), data = alphadiv)
lmR <- lm(sqrt(richness)~ time*treatment*species, data = alphadiv)
dotplot(ranef(lmerR, condVar = TRUE))
ranova(lmerR)
AICc(lmerR,lmR) # lmerR has the lower AIC
anova(lmerR,lmR)

anova(lmerR)
anova(lmR)
var.plots(lmerR)
normality.plots(lmerR)
# post hoc tests
lmerRe <- emmeans(lmerR, list(pairwise ~ time*species), adjust = "tukey")
lmerRep <- as.data.frame(lmerRe$`pairwise differences of time, species`)
lmerRep <- lmerRep[order(lmerRep$p.value),]
head(lmerRep, n = 10L)

lmR <- lm(sqrt(richness) ~ time*treatment*species, data = alphadiv)
anova(lmR)
lmRe <- emmeans(lmR, list(pairwise ~ time*species), adjust = "tukey")
lmRep <- as.data.frame(lmRe$`pairwise differences of time, species`)
lmRep <- lmRep[order(lmRep$p.value),]
head(lmRep, n = 11L)


# Simpson's Index
# do not include random effect
lmerR <- lmer(asinTransform(evenness)~ time*treatment*species + (1|indiv), data = alphadiv)
lmR <- lm(asinTransform(evenness)~ time*treatment*species, data = alphadiv)
dotplot(ranef(lmerR, condVar = TRUE))
ranova(lmerR)
AICc(lmerR,lmR)
anova(lmerR,lmR)

anova(lmerR)
summary(lmerR) # random effect variance explains .06
anova(lmR)
var.plots(lmerR)
var.plots(lmR)
normality.plots(lmerR)
normality.plots(lmR)
# post hoc tests
lmerRe <- emmeans(lmerR, list(pairwise ~ time*species), adjust = "tukey")
lmerRep <- as.data.frame(lmerRe$`pairwise differences of time, species`)
lmerRep <- lmerRep[order(lmerRep$p.value),]
head(lmerRep, n = 10L)

lmRe <- emmeans(lmR, list(pairwise ~ time*species), adjust = "tukey")
lmRep <- as.data.frame(lmRe$`pairwise differences of time, species`)
lmRep <- lmRep[order(lmRep$p.value),]
head(lmRep, n = 10L)

# Faith's PD
lmerR <- lmer(sqrt(faithPD)~ time*treatment*species + (1|indiv), data = alphadiv)
lmR <- lm(sqrt(faithPD)~ time*treatment*species, data = alphadiv)
dotplot(ranef(lmerR, condVar = TRUE))
ranova(lmerR)
AICc(lmerR,lmR)
anova(lmerR,lmR)

anova(lmerR)
summary(lmerR) # random effect of individual explains 1.503 of the variance
anova(lmR)
var.plots(lmerR)
var.plots(lmR)
normality.plots(lmerR)
normality.plots(lmR)
# post hoc tests
lmerRe <- emmeans(lmerR, list(pairwise ~ time*species), adjust = "tukey")
lmerRep <- as.data.frame(lmerRe$`pairwise differences of time, species`)
lmerRep <- lmerRep[order(lmerRep$p.value),]
head(lmerRep, n = 10L)

lmRe <- emmeans(lmR, list(pairwise ~ time*species), adjust = "tukey")
lmRep <- as.data.frame(lmRe$`pairwise differences of time, species`)
lmRep <- lmRep[order(lmRep$p.value),]
head(lmRep, n = 10L)
```

### 3 Analysis with one-way ANOVA and Kruskal-Wallis
#### Chao1 data (richness)
Proceeding with sqrt-transformed richness data
```{r rich}
summary(aov(sqrt(richness) ~ time, data = alphadiv))
summary(aov(sqrt(richness) ~ treatment, data = alphadiv)) # not sig
summary(aov(sqrt(richness) ~ species, data = alphadiv))

TukeyHSD(aov(sqrt(richness) ~ time*species*treatment + Error(indiv), data = alphadiv))
# TukeyHSD(aov(sqrt(richness) ~ treatment, data = alphadiv))
TukeyHSD(aov(sqrt(richness) ~ species, data = alphadiv))
```

#### Simpson's index data (evenness)
Proceeding with non-parametric kruskal wallis test from Simpsons data
```{r even}
kruskal.test(evenness ~ time, data = alphadiv)
kruskal.test(evenness ~ treatment, data = alphadiv) # not sig
kruskal.test(evenness ~ species, data = alphadiv) # not sig

dunnTest(evenness ~ time, data = alphadiv, method = "bh")

summary(aov(asinTransform(evenness) ~ time, data = alphadiv))
summary(aov(asinTransform(evenness) ~ treatment, data = alphadiv)) # not sig
summary(aov(asinTransform(evenness) ~ species, data = alphadiv)) # not sig
summary(aov(asinTransform(evenness) ~ time*treatment*species, data = alphadiv))
summary(aov(asinTransform(evenness) ~ time + species, data = alphadiv))
TukeyHSD(aov(asinTransform(evenness) ~ time, data = alphadiv))
```
#### Faith's phylogenetic diversity data (faithPD)
Proceeding with sqrt-transformed faithPD data
```{r faithPD}
kruskal.test(faithPD ~ time, data = alphadiv)
kruskal.test(faithPD ~ treatment, data = alphadiv) # not sig
kruskal.test(faithPD ~ species, data = alphadiv) # sig

dunnTest(faithPD ~ time, data = alphadiv, method = "bh")
dunnTest(faithPD ~ species, data = alphadiv, method = "bh")

summary(aov(sqrt(faithPD) ~ time, data = alphadiv))
summary(aov(sqrt(faithPD) ~ treatment, data = alphadiv)) # not sig
summary(aov(sqrt(faithPD) ~ species, data = alphadiv))

TukeyHSD(aov(sqrt(faithPD) ~ time, data = alphadiv))
# TukeyHSD(aov(sqrt(faithPD) ~ treatment, data = alphadiv))
TukeyHSD(aov(sqrt(faithPD) ~ species, data = alphadiv))
```
Check for interactions
```{r int}
summary(aov(sqrt(richness) ~ time*treatment*species, data = alphadiv))
summary(aov(sqrt(faithPD) ~ time*treatment*species, data = alphadiv))
summary(aov(asinTransform(evenness) ~ time*treatment*species, data = alphadiv))
# This interaction test with Kruskal wallis is not comparable to anova
int <- interaction(alphadiv$time, alphadiv$treatment, alphadiv$species)
kruskal.test(evenness ~ int, data = alphadiv)
int_sig <- dunnTest(evenness ~ int, data = alphadiv, method = "bh")
intdf <- as.data.frame(int_sig$res) 
intdf <- as.data.frame(int_sig$res)
head(new) # only three significant interactions
```

### For Acropora only
Subsetting the data to only include Acropora corals
```{r}
alphadiv_acr <- alphadiv[which(alphadiv$species =="ACR"),]
summary(alphadiv_acr)
```
#### Chao1 data (richness)
Proceeding with sqrt-transformed richness data
```{r rich2}
summary(aov(sqrt(richness) ~ time, data = alphadiv_acr))
summary(aov(sqrt(richness) ~ treatment, data = alphadiv_acr)) # not sig

TukeyHSD(aov(sqrt(richness) ~ time, data = alphadiv_acr))
# TukeyHSD(aov(sqrt(richness) ~ treatment, data = alphadiv_acr))
```

#### Simpson's index data (evenness)
Proceeding with non-parametric kruskal-wallis test for simpson's data
```{r even2}
kruskal.test(evenness ~ time, data = alphadiv_acr)
kruskal.test(evenness ~ treatment, data = alphadiv_acr) # not sig

dunnTest(evenness ~ time, data = alphadiv_acr, method = "bh")

summary(aov(asinTransform(evenness) ~ time, data = alphadiv_acr))
summary(aov(asinTransform(evenness) ~ treatment, data = alphadiv_acr)) # not sig

TukeyHSD(aov(asinTransform(evenness) ~ time, data = alphadiv_acr))
# TukeyHSD(aov(asinTransform(evenness) ~ treatment, data = alphadiv_acr))
```
#### Faith's phylogenetic diversity data (faithPD)
Proceeding with sqrt-transformed faithPD data
```{r faithPD2}
summary(aov(sqrt(faithPD) ~ time, data = alphadiv_acr))
summary(aov(sqrt(faithPD) ~ treatment, data = alphadiv_acr)) # not sig

TukeyHSD(aov(sqrt(faithPD) ~ time, data = alphadiv_acr))
# TukeyHSD(aov(sqrt(faithPD) ~ treatment, data = alphadiv_acr))
```
Check for interactions
```{r int2}
summary(aov(sqrt(richness) ~ time*treatment, data = alphadiv_acr))
summary(aov(sqrt(faithPD) ~ time*treatment, data = alphadiv_acr))
summary(aov(asinTransform(evenness) ~ time*treatment, data = alphadiv_acr))
# This interaction test with Kruskal wallis is not comparable to anova
int <- interaction(alphadiv_acr$time, alphadiv_acr$treatment)
kruskal.test(evenness ~ int, data = alphadiv_acr)
int_sig <- dunnTest(evenness ~ int, data = alphadiv_acr, method = "bh")
intdf <- as.data.frame(int_sig$res)
new <- intdf[order(intdf$P.adj),]
head(new) # no sig
```